---
title: 'Projecte de comparacio de CATALEGS:   `r params$bd.dindex`'
author: "Jordi Real & Rai Puig"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"


output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

params:
  dir_dades_origen: "../../DADES/HTG/mostra" #"../DADES/HTG/HTG" # 
  dir_dades_desti:  "dades"                 #"dades/poblacio"  #
---


&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>



<div class="watermark">DRAFT</div>




# FASE LECTURA

>> Generacio de la taula plana  

```{r setup, include = FALSE}
#rm(list=ls())

library(dplyr)
library(lubridate)   
library(writexl)

# Funcions 
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

conductor_codis<-here::here("Cataleg_ORIGINAL.xlsx")
conductor_codis2<-here::here("Cataleg_PROJECTE.xlsx")

#conductor_codis3
#conductor_codis4

directori_dades_origen<-params$dir_dades_origen


# el nostre cataleg , nomes consta:
#
#només es fara per aquest DOMINI!:
#
#diagnostics
#cmbdh_diagnostics
#cmbdh_procediments
#farmacs_facturats
#farmacs_prescrits
#
#####################################################################################################################################
#i)
#Funcio compar_catal:Observa si hi ha codis de dt2(Cataleg_Projecte), que no estiguin a dt1(Cataleg_Original).
#
#ii)
#Els enviem a un investigador que hi posara , el seu pertinent AGR.
#
#iii)
#Un cop rebem els codis amb els seus AGR pertients, ho afegirem al dt1(Cataleg_Original).
#
#iv)
#Seleccionem del dt1, aquells codis que siguin nomes pel PROJECTE, i ho tornem a enviar al investigador perque hi posi els AGR1.
#
#v)
#Un cop rebut, ja tindrem el CATALEG_PROJECTE , preparat!!!
#
#####################################################################################################################################


compar_catal<-function(dt1=cataleg_estandard,dt2=cataleg_nou){

    #dt1=cataleg  #dt1(Catàleg_nou);  #catalaeg actual
    #dt2=cataleg2 #dt2(catàleg_gran!) #cataleg dels PROJECTE!

    K1<-dt1%>%select(cod)%>%group_by(cod)%>%dplyr::slice(1)%>%ungroup()
    K2<-dt2%>%select(cod)%>%group_by(cod)%>%dplyr::slice(1)%>%ungroup() 
    
    #length(K1$cod)
    #length(K2$cod)
    
    codis_falten<-K2%>%
      anti_join(K1,by="cod")
    
    codis_falten
    
    
    }


dades<-readxl::read_excel(conductor_codis,col_types = "text")


# Actualitza conductor amb noves variables en dades 

ActualitzarConductor<-function(d=dades,taulavariables="VARIABLES_R3b.xlsx") {
  
  # taulavariables="variables_metplus_test.xlsx"
  # d=dades
  
   taulavariables="conductor.xlsx"
   d=conductor_codis2
  
  
  # Llegir conductor
  variables<-readxl::read_excel(taulavariables) %>% tidyr::as_tibble()

  # Si el format es xls exportar a xls cambiar de format
  if (readxl::excel_format(taulavariables)=="xls") {
    taulavariables<-stringr::str_replace(taulavariables,"xls","xlsx")
    openxlsx::write.xlsx(variables,taulavariables)}
  
  # Guardar posició de camp i descripció
  posicio_camp <- which(names(variables) == "camp")
  posicio_desc <- which(names(variables) == "descripcio")
  
  #----------------------------------------------------------#
  var_dades<-names(dades)%>% as_tibble() %>% select("camp"=value) %>%mutate("descripcio"=camp)
  var_conductor<-variables["camp"]

  #----------------------------------------------------------#
  #var_dades
  #var_conductor
  #----------------------------------------------------------#
  var_afegir<-var_dades %>% anti_join(var_conductor,by="camp")
  #var_afegir
  #----------------------------------------------------------#
  # afegeix al final 
  #variables2<-variables %>% bind_rows(var_afegir)
 
   #----------------------------------------------------------#
  wb<-openxlsx::loadWorkbook(taulavariables)
  n<-(openxlsx::readWorkbook(wb,sheet=1)[,1] %>% length())+2
  n2<-colnames(variables)%>% length()
  #----------------------------------------------------------#
  #var0<-var_afegir%>%as.data.frame
  var1<-var_afegir[1]
  var2<-var_afegir[2]
  #----------------------------------------------------------#
  var1 <- var1[['camp']]
  var2 <- var2[['descripcio']]
  #----------------------------------------------------------#
  # negStyle <- openxlsx::createStyle(fontColour = "#9C0006", bgFill = "#FFC7CE")
  # posStyle <- openxlsx::createStyle(fontColour = "#006100", bgFill = "#C6EFCE")
  #----------------------------------------------------------#
  openxlsx::writeData(wb, sheet=1,var1,startCol = posicio_camp,startRow = n)
  openxlsx::writeData(wb, sheet=1,var2,startCol = posicio_desc,startRow = n)

  # openxlsx::conditionalFormatting(wb, sheet=1, cols=1:(n2), rows=(n):(n+1000),rule="!=0",style =posStyle)
  
  #
 
  openxlsx::saveWorkbook(wb, file = taulavariables, overwrite = TRUE)
  openxlsx::openXL(taulavariables)

  
}


ActualitzarConductor2<-function(d=dades,taulavariables="VARIABLES_R3b.xlsx",lloc=0,my.vec=c(" "," ")) {
  
  #------------------------------------#
  #lloc=0
  #my.vec=c("ZZ","ZZ")
  #taulavariables="VARIABLES_R3b.xlsx"
  #d=dades
  #------------------------------------#
  
  # Llegir conductor
  variables<-readxl::read_excel(taulavariables) %>% tidyr::as_tibble()
  
  # Si el format es xls exportar a xls cambiar de format
  if (readxl::excel_format(taulavariables)=="xls") {
    taulavariables<-stringr::str_replace(taulavariables,"xls","xlsx")
    openxlsx::write.xlsx(variables,taulavariables)}
  
  # Guardar posició de camp i descripció
  posicio_camp <- which(names(variables) == "camp")
  posicio_desc <- which(names(variables) == "descripcio")
  #----------------------------------------------------------#
  var_dades<-names(dades)%>% as_tibble() %>% select("camp"=value) %>%mutate("descripcio"=camp)
  var_conductor<-variables["camp"]
  #----------------------------------------------------------#
  #var_dades
  #var_conductor
  #----------------------------------------------------------#
  var_afegir<-var_dades %>% anti_join(var_conductor,by="camp")
  #var_afegir
  #----------------------------------------------------------#
  # afegeix al final 
  #----------------------------------------------------------#
  wb<-openxlsx::loadWorkbook(taulavariables)
  n<-(openxlsx::readWorkbook(wb,sheet=1)[,1] %>% length())+2
  n2<-colnames(variables)%>% length()
  #----------------------------------------------------------#
  var1<-var_afegir[1]
  var2<-var_afegir[2]
  #----------------------------------------------------------#
  var1 <- var1[['camp']]
  var2 <- var2[['descripcio']]
  #----------------------------------------------------------#
  posStyle <- openxlsx::createStyle(fontColour = "#006100", bgFill = "#C6EFCE")
  #----------------------------------------------------------#
  openxlsx::writeData(wb, sheet=1,var1,startCol = posicio_camp,startRow = n)
  openxlsx::writeData(wb, sheet=1,var2,startCol = posicio_desc,startRow = n)
  openxlsx::conditionalFormatting(wb, sheet=1, cols=1:(n2), rows=(n):(n+1000),rule="!=0",style =posStyle)
  #----------------------------------------------------------#
  openxlsx::saveWorkbook(wb, file = taulavariables, overwrite = TRUE)
  variables2<-readxl::read_excel(taulavariables) %>% tidyr::as_tibble()
  #----------------------------------------------------------# 
  x<- rep(" ", times = n2-length(my.vec))
  my.vec2    <- c(my.vec,x)
  #----------------------------------------------------------#
  new.data <- rbind(variables2[1:(lloc), ], my.vec2, variables2[(lloc+1):length(variables2[,1]),])
  openxlsx::writeData(wb,sheet=1,new.data,startCol = 1,startRow = 1)
  if (lloc==0) {
    openxlsx::writeData(wb,sheet=1,variables2,startCol = 1,startRow = 1)
  }
  openxlsx::saveWorkbook(wb, file = taulavariables, overwrite = TRUE)
  openxlsx::openXL(taulavariables)
}







```



## i.Comparacio entre el Cataleg Original i el Cataleg Projecte

```{r i,include=T}

#####################################################################################################################################
#i)
#Funcio compar_catal:Observa si hi ha codis de dt2(Cataleg_Projecte), que no estiguin a dt1(Cataleg_Original).
#


cataleg<-readxl::read_excel(conductor_codis,col_types = "text")



#####################################################################################################################################



#[ el nou Projecte]# ::

cataleg2<-readxl::read_excel(conductor_codis2,col_types = "text")%>% 
  select(cod,Descripcio)%>%
    group_by(cod)%>%dplyr::slice(1)%>%ungroup()





Codis_Bogdan<-compar_catal(dt1=cataleg,dt2=cataleg2)%>%
  left_join(cataleg2,by="cod")

#write.csv(PACIENT_599_medic,"PACIENT_599_medic.csv")


write_xlsx(Codis_Bogdan, "Codis_Bogdan.csv")









```
## ii.Els enviem a un investigador que hi posara , el seu pertinent AGR.

```{r ii,include=T}

# ho  rebo del investigador!!!

#cataleg_corregit1<-readxl::read_excel(conductor_codis3,col_types = "text")



```

## iii.Un cop rebem els codis amb els seus AGR pertients, ho afegirem al dt1(Cataleg_Original).

```{r iii,include=T}

#add al cataleg Original!


```
## iv.Seleccionem del dt1, aquells codis que siguin nomes pel PROJECTE, i ho tornem a enviar al investigador perque hi posi els AGR1.
```{r iv,include=T}

#cataleg_corregit2<-readxl::read_excel(conductor_codis4,col_types = "text")


```
## v.Un cop rebut, ja tindrem el CATALEG_PROJECTE , preparat.

```{r v,include=T}

#semi join

```

## 5. Salvar Taula Plana
```{r salvar}
saveRDS(cataleg2, file=here::here(params$dir_dades_desti,"cataleg.rds"))

```






